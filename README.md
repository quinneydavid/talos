# Talos Cluster Configuration

This repository contains the configuration for a Talos-based Kubernetes cluster using PXE boot with Matchbox.

## Overview

The system uses a simple, secure approach to manage Talos configurations:

- Base configurations stored in Git (no secrets)
- Node-specific settings in matchbox group files
- Configurations with secrets generated at runtime

## Structure

```
.
├── configs/                    # Base Talos configurations
│   ├── controlplane.yaml      # Control plane base config
│   ├── worker.yaml            # Worker node base config
│   └── storage-class.yaml     # Storage class for Synology CSI
├── docker/                    # Docker configurations
│   ├── docker-compose.yml     # Docker Compose configuration
│   ├── Dockerfile.matchbox    # Matchbox server with talosctl
│   └── Dockerfile.matchbox-tftp # TFTP server for PXE boot
├── matchbox/                  # Matchbox configurations
│   ├── groups/               # Node group definitions
│   │   ├── cp1.json         # Control plane 1 settings
│   │   ├── cp2.json         # Control plane 2 settings
│   │   ├── cp3.json         # Control plane 3 settings
│   │   ├── worker1.json     # Worker 1 settings
│   │   └── worker2.json     # Worker 2 settings
│   └── profiles/            # Boot profiles
└── scripts/                  # Utility scripts
    └── generate-configs.sh   # Config generation script
```

## Configuration

### Base Configurations

Base configurations in `configs/` contain only non-sensitive settings:

```yaml
# configs/controlplane.yaml
machine:
  type: controlplane
  install:
    disk: /dev/sda
```

### Node Configuration

Each node's settings are defined in `matchbox/groups/`. Nodes have dual network interfaces:
- eth0: Primary network (192.168.86.0/24)
- eth1: Storage network (10.44.5.0/24)

Example node configuration:
```json
{
    "id": "cp1",
    "name": "Control Plane Node 1",
    "profile": "control-plane",
    "selector": {
      "mac": "50:6b:8d:96:f7:50"
    },
    "metadata": {
      "ip": "192.168.86.211",        # Primary network IP
      "gateway": "192.168.86.1",
      "netmask": "255.255.255.0",
      "storage_ip": "10.44.5.10",    # Storage network IP
      "hostname": "cp1",
      "nameservers": ["192.168.86.2", "192.168.86.4"]
    }
}
```

### Storage Configuration

The cluster uses a dedicated storage network for Synology CSI:

1. Each node has a storage network interface (eth1) configured via group files
2. Storage IPs are in the 10.44.5.0/24 network:
   - Control plane nodes: 10.44.5.10-12
   - Worker nodes: 10.44.5.20-21
   - Synology NAS: 10.44.5.2

The storage class configuration is defined in `configs/storage-class.yaml`:
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: synology-csi
provisioner: csi.synology.com
parameters:
  fsType: ext4
  location: "10.44.5.2"  # Synology NAS IP on storage network
  storage_pool: "volume1"
```

## How It Works

1. The matchbox container includes talosctl and the config generation script
2. On startup, it:
   - Downloads profiles and group files from GitHub
   - Generates node configurations using talosctl
   - Configures both network interfaces
   - Stores configs with secrets in matchbox assets
   - Serves configurations via PXE boot

## Security

- Base configurations and node settings in Git (no secrets)
- Secrets generated by talosctl at runtime
- Generated configs stored only on matchbox server
- Each node gets its own configuration with unique secrets

## Usage

1. Update base configurations in `configs/` if needed
2. Update node settings in `matchbox/groups/` if needed
3. Start the services:
   ```bash
   cd docker
   docker-compose up -d
   ```

The matchbox container will automatically:
- Generate fresh configurations with new secrets
- Configure network settings from group files
- Make configurations available for PXE boot
