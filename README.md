# Talos Cluster Configuration

This repository contains the configuration for a Talos-based Kubernetes cluster using PXE boot with Matchbox.

## Overview

- Uses Matchbox for PXE boot configuration
- Generates Talos node configurations using talosctl
- Maintains base configurations in version control
- Keeps generated configs with secrets only on the Matchbox server

## Structure

```
.
├── configs/                    # Base Talos configurations (no secrets)
│   ├── controlplane.yaml      # Control plane node base config
│   └── worker.yaml            # Worker node base config
├── docker/                    # Docker configurations
│   ├── docker-compose.yml     # Docker Compose configuration
│   ├── Dockerfile.matchbox    # Matchbox server with talosctl
│   └── Dockerfile.matchbox-tftp # TFTP server for PXE boot
├── matchbox/                  # Matchbox configurations
│   ├── groups/               # Node group definitions with network settings
│   │   ├── cp1.json         # Control plane 1 settings
│   │   ├── cp2.json         # Control plane 2 settings
│   │   ├── cp3.json         # Control plane 3 settings
│   │   ├── worker1.json     # Worker 1 settings
│   │   └── worker2.json     # Worker 2 settings
│   └── profiles/             # Boot profiles
└── scripts/                   # Utility scripts
    └── generate-configs.sh    # Config generation script

## Node Configuration

Each node's network configuration is defined in its corresponding group file under `matchbox/groups/`. For example:

```json
{
    "id": "cp1",
    "name": "Control Plane Node 1",
    "profile": "control-plane",
    "selector": {
      "mac": "50:6b:8d:96:f7:50"
    },
    "metadata": {
      "ip": "192.168.86.211",      # Primary network IP
      "gateway": "192.168.86.1",
      "netmask": "255.255.255.0",
      "storage_ip": "10.44.5.10",  # Storage network IP
      "hostname": "cp1"
    }
}
```

The `generate-configs.sh` script reads these group files to configure:
- Primary network interface (eth0)
- Storage network interface (eth1)
- Hostname and routing settings

## Usage

1. Base configurations (controlplane.yaml and worker.yaml) are stored in the configs directory and can be customized as needed.

2. Update node-specific settings in the matchbox/groups/ JSON files.

3. Start the services:
   ```bash
   cd docker
   docker-compose up -d
   ```

4. The matchbox container will:
   - Download required Talos assets
   - Generate node configurations using talosctl
   - Configure network interfaces based on group files
   - Serve configurations via PXE boot

## Security

- Base configurations in this repo contain no secrets
- Generated configurations with secrets are only stored on the Matchbox server
- Node-specific network settings are managed through group files
- Secrets are generated by talosctl during container startup
